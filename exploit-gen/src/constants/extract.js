import fs from 'fs';
import path from 'path';

const directoryPath = './webidl';

const DOM_NODE_STANDARD = {};
const MIXINS = {};

function parseWebIDL(content) {
  const tagNameMatch = content.match(/interface (\w+)(?:\s*:\s*(\w+))?/);
  const tagName = tagNameMatch ? tagNameMatch[1] : null;
  const parentTagName = tagNameMatch ? tagNameMatch[2] : null;

  const attributesDOMString = [];
  const reflectAttributesDOMString = [];
  const apis = [];
  const includes = [];

  const lines = content.split('\n');
  lines.forEach(line => {
    line = line.trim();

    if (line.includes('attribute DOMString')) {
      const attrMatch = line.match(/attribute DOMString (\w+);/);
      const isReflect = line.includes('Reflect');
      if (attrMatch) {
        attributesDOMString.push(attrMatch[1]);
        if (isReflect) {
          reflectAttributesDOMString.push(attrMatch[1]);
        }
      }
    } else if (/DOMString \w+\(/.exec(line)) {
      const apiMatch = line.match(/DOMString (\w+)\(/);
      if (apiMatch) {
        apis.push(apiMatch[1]);
      }
    } else if (line.includes('includes')) {
      const includesMatch = line.match(/(\w+) includes (\w+);/);
      if (includesMatch) {
        includes.push(includesMatch[2]);
      }
    } else if (line.includes('mixin')) {
      // Handle mixins
      const mixinMatch = line.match(/interface mixin (\w+)/);
      if (mixinMatch) {
        const mixinName = mixinMatch[1];
        MIXINS[mixinName] = { attributesDOMString: [], apis: [] };

        // Collect attributes and APIs for the mixin
        const mixinLines = content.split('\n');
        mixinLines.forEach(mixinLine => {
          mixinLine = mixinLine.trim();
          if (mixinLine.includes('stringifier attribute USVString')) {
            const attrMatch = mixinLine.match(/stringifier attribute USVString (\w+);/);
            if (attrMatch) {
              MIXINS[mixinName].attributesDOMString.push(attrMatch[1]);
            }
          } else if (/USVString \w+\(/.exec(mixinLine)) {
            const apiMatch = mixinLine.match(/USVString (\w+)\(/);
            if (apiMatch) {
              MIXINS[mixinName].apis.push(apiMatch[1]);
            }
          }
        });
      }
    }
  });

  return { tagName, parentTagName, attributesDOMString, reflectAttributesDOMString, apis, includes };
}

function applyInheritance() {
  for (const [tagName, data] of Object.entries(DOM_NODE_STANDARD)) {
    let currentParent = data.parentTagName;
    while (currentParent) {
      const parentData = DOM_NODE_STANDARD[currentParent];
      if (parentData) {
        // Inherit attributes and APIs
        data.attributesDOMString = [...new Set([...parentData.attributesDOMString, ...data.attributesDOMString])];
        data.reflectAttributesDOMString = [...new Set([...parentData.reflectAttributesDOMString, ...data.reflectAttributesDOMString])];
        data.apis = [...new Set([...parentData.apis, ...data.apis])];
        currentParent = parentData.parentTagName;
      } else {
        currentParent = null;
      }
    }

    // Apply mixins
    data.includes.forEach(mixin => {
      if (MIXINS[mixin]) {
        data.attributesDOMString = [...new Set([...MIXINS[mixin].attributesDOMString, ...data.attributesDOMString])];
        data.apis = [...new Set([...MIXINS[mixin].apis, ...data.apis])];
      }
    });
  }
}

fs.readdir(directoryPath, (err, files) => {
  if (err) {
    console.error('Unable to scan directory:', err);
    return;
  }

  // First, parse all files and store them in the DOM_NODE_STANDARD object
  files.forEach(file => {
    if (path.extname(file) === '.webidl') {
      const filePath = path.join(directoryPath, file);
      const content = fs.readFileSync(filePath, 'utf-8');
      const { tagName, parentTagName, attributesDOMString, reflectAttributesDOMString, apis, includes } = parseWebIDL(content);

      if (tagName) {
        DOM_NODE_STANDARD[tagName] = {
          parentTagName: parentTagName || null,
          attributesDOMString: attributesDOMString,
          reflectAttributesDOMString: reflectAttributesDOMString,
          apis: apis,
          includes: includes
        };
      }
    }
  });

  // Apply inheritance and mixins after all files have been parsed
  applyInheritance();

  fs.writeFileSync('dom-node-standard.js', 'const DOM_NODE_STANDARD = ' + JSON.stringify(DOM_NODE_STANDARD, null, 2) + ';\n export { DOM_NODE_STANDARD };');
});
